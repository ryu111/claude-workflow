# 程式碼抽取計劃範本

## 問題描述

**發現時間**：[YYYY-MM-DD HH:mm]
**發現人**：[Agent 名稱]

**問題類型**：
- [ ] 相同邏輯重複 2+ 次
- [ ] 相似模式重複 3+ 次
- [ ] 複製貼上程式碼
- [ ] 其他：[...]

**影響範圍**：
- 重複次數：[N] 次
- 涉及檔案：[N] 個
- 程式碼行數：約 [N] 行（單次）

## 重複程式碼位置

### 位置 1

**檔案**：`[檔案路徑]`
**行數**：L[開始行]-L[結束行]

```[language]
// 重複的程式碼片段
```

**使用情境**：
> [描述這段程式碼在此處的用途]

### 位置 2

**檔案**：`[檔案路徑]`
**行數**：L[開始行]-L[結束行]

```[language]
// 重複的程式碼片段
```

**使用情境**：
> [描述這段程式碼在此處的用途]

### 位置 3（如適用）

...

## 共同模式識別

### 核心邏輯

```[language]
// 抽取出的核心邏輯（偽代碼）
function extractedLogic(params) {
  // 共同的處理流程
}
```

### 差異點分析

| 位置 | 差異內容 | 是否可參數化 |
|------|----------|--------------|
| 位置 1 | [差異描述] | 是 / 否 |
| 位置 2 | [差異描述] | 是 / 否 |
| 位置 3 | [差異描述] | 是 / 否 |

### 通用化策略

**參數設計**：
```[language]
interface ExtractedFunctionParams {
  // 必要參數
  param1: Type1;
  param2: Type2;

  // 可選參數（處理差異點）
  option1?: OptionType1;
  option2?: OptionType2;
}
```

**預設值設定**：
- `option1` 預設：[值]
- `option2` 預設：[值]

## 抽取計劃

### 新模組規劃

**建議位置**：`[檔案路徑]`

**模組類型**：
- [ ] 工具函式（utils/helpers）
- [ ] 共用元件（components/common）
- [ ] 業務邏輯（services/lib）
- [ ] 類型定義（types）

**命名建議**：
- 函式名：`[functionName]`
- 檔案名：`[file-name].[ext]`

**介面定義**：
```[language]
/**
 * [功能簡述]
 *
 * @param {Type} param1 - [參數說明]
 * @param {Type} param2 - [參數說明]
 * @returns {ReturnType} [返回值說明]
 *
 * @example
 * // 使用範例
 * const result = functionName(arg1, arg2);
 */
export function functionName(
  param1: Type1,
  param2: Type2,
  options?: Options
): ReturnType {
  // 實作
}
```

### 抽取步驟

#### 第 1 步：建立共用模組

- [ ] 在 `[路徑]` 建立 `[檔案名]`
- [ ] 實作核心邏輯
- [ ] 撰寫 JSDoc/docstring
- [ ] 新增單元測試
- [ ] 通過測試

#### 第 2 步：替換使用處 1

- [ ] 檔案：`[路徑]`
- [ ] 移除舊程式碼（L[開始]-L[結束]）
- [ ] 引入共用模組：`import { functionName } from '[路徑]'`
- [ ] 呼叫新函式：`functionName(arg1, arg2, options)`
- [ ] 測試功能正常

#### 第 3 步：替換使用處 2

- [ ] 檔案：`[路徑]`
- [ ] 移除舊程式碼（L[開始]-L[結束]）
- [ ] 引入共用模組
- [ ] 呼叫新函式
- [ ] 測試功能正常

#### 第 4 步：替換使用處 3（如適用）

...

#### 第 5 步：回歸測試

- [ ] 執行所有相關測試
- [ ] 確認無功能退化
- [ ] 效能測試（如適用）

#### 第 6 步：文件更新

- [ ] 更新相關文件
- [ ] 新增使用範例
- [ ] 標記為推薦使用

## 影響分析

### 修改範圍

| 檔案 | 變更類型 | 變更行數 | 風險等級 |
|------|----------|----------|----------|
| [新檔案] | 新增 | +[N] | 🟢 低 |
| [檔案 1] | 重構 | -[N], +[M] | 🟡 中 |
| [檔案 2] | 重構 | -[N], +[M] | 🟡 中 |

### 風險評估

| 風險項目 | 等級 | 說明 | 緩解措施 |
|----------|------|------|----------|
| 破壞現有功能 | 🟢 低 / 🟡 中 / 🔴 高 | [...] | [...] |
| 邊界情況遺漏 | 🟢 低 / 🟡 中 / 🔴 高 | [...] | [...] |
| 效能退化 | 🟢 低 / 🟡 中 / 🔴 高 | [...] | [...] |

### 向下相容性

- [ ] ✅ 完全向下相容
- [ ] ⚠️ 需要遷移現有程式碼（破壞性變更）
- [ ] ℹ️ 新功能，無相容性問題

## 預期效益

### 程式碼品質提升

- **減少重複**：移除 [N] 處重複程式碼
- **程式碼行數**：淨減少約 [N] 行
- **可維護性**：單一修改點，降低維護成本

### 可複用性

- **潛在使用場景**：[場景 1], [場景 2], [場景 3]
- **未來擴展性**：[說明如何擴展]

### 測試覆蓋率

- **新增測試**：[N] 個測試案例
- **覆蓋率提升**：預計 +[N]%

## 執行時程

| 步驟 | 預估時間 | 負責 Agent | 依賴 |
|------|----------|------------|------|
| 建立共用模組 | [N] 分鐘 | DEVELOPER | - |
| 替換使用處 1 | [N] 分鐘 | DEVELOPER | 步驟 1 |
| 替換使用處 2 | [N] 分鐘 | DEVELOPER | 步驟 1 |
| 回歸測試 | [N] 分鐘 | TESTER | 步驟 2-3 |
| 程式碼審查 | [N] 分鐘 | REVIEWER | 步驟 4 |

**總計**：約 [N] 分鐘

## 備註

### 注意事項

- [注意事項 1]
- [注意事項 2]

### 參考資料

- [相關文件或討論連結]

---

**計劃制定人**：[Agent 名稱]
**制定時間**：[YYYY-MM-DD HH:mm]
**關聯任務**：[Task ID 或 Change ID]
**優先級**：🔴 高 / 🟡 中 / 🟢 低
