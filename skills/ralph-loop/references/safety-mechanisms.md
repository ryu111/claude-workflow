# 安全閥機制

> 此文件定義 Ralph Loop 的安全限制和智能完成偵測邏輯。

---

## 概述

Ralph Loop 有多重安全機制防止無限迴圈和異常狀況：

1. **最大迭代次數** - 硬性上限
2. **連續錯誤限制** - 異常中斷
3. **智能完成偵測** - 自動退出
4. **用戶中斷** - 手動控制

---

## 安全閥限制

### 限制參數

| 限制 | 數值 | 觸發行為 |
|------|------|----------|
| 最大迭代次數 | 100 | 暫停 Loop，等待用戶確認 |
| 連續錯誤次數 | 3 | 暫停 Loop，報告錯誤 |

### 迭代計數規則

- 每次 `Task` 工具呼叫算 1 次迭代
- 包括 DEVELOPER、REVIEWER、TESTER 調用
- 在進度報告中顯示 `迭代: #N / 100`

### 達到限制時顯示

```
╔════════════════════════════════════════════════════════════════╗
║                    ⚠️ Loop 安全閥觸發                           ║
╚════════════════════════════════════════════════════════════════╝

⚠️ 已達最大迭代次數 (100)
📊 當前進度: X/Y 任務完成

請確認是否繼續：
- 「繼續」- 再執行 100 次迭代
- 「暫停」- 停止 Loop
```

---

## 智能完成偵測

### 偵測邏輯

每完成一個任務後，**必須**執行：

1. 讀取 `tasks.md` 檔案
2. 計算 checkbox 狀態：
   - 總數：`- [` 開頭的行數
   - 完成：`- [x]` 開頭的行數
3. 判斷是否全部完成：
   - ✅ 全部完成 → 輸出完成承諾，退出 Loop
   - ❌ 未完成 → 繼續下一個任務

### 完成時行為

當所有任務完成時：

```markdown
1. 顯示完成訊息
2. 輸出 <promise>所有任務完成</promise>
3. Stop hook 偵測到承諾 → 允許退出
```

### 承諾標籤格式

```xml
<promise>所有任務完成</promise>
```

**重要**：只有在所有任務**確實完成**時才能輸出此標籤。虛假承諾會破壞工作流完整性。

---

## 錯誤處理

### 錯誤類型與處理

| 錯誤類型 | 計入連續錯誤 | 處理方式 |
|----------|:------------:|----------|
| REVIEWER REJECT | ❌ | 返回 DEVELOPER 修復 |
| TESTER FAIL | ❌ | DEBUGGER 分析 → DEVELOPER 修復 |
| Agent 執行錯誤 | ✅ | 記錄錯誤，嘗試重試 |
| 找不到任務 | ✅ | 報告錯誤 |
| 檔案操作失敗 | ✅ | 報告錯誤 |

### 連續錯誤處理

```
第 1 次錯誤 → 記錄，繼續嘗試
第 2 次錯誤 → 記錄，繼續嘗試
第 3 次錯誤 → 暫停 Loop，報告錯誤
```

### 錯誤報告格式

```
╔════════════════════════════════════════════════════════════════╗
║                    ❌ Loop 錯誤中斷                             ║
╚════════════════════════════════════════════════════════════════╝

⚠️ 連續發生 3 次錯誤
📊 當前進度: X/Y 任務完成

錯誤詳情：
1. [錯誤類型]: [錯誤描述]
2. [錯誤類型]: [錯誤描述]
3. [錯誤類型]: [錯誤描述]

建議操作：
- 檢查錯誤原因並修復
- 使用「繼續」重新嘗試
- 使用「暫停」中止 Loop
```

---

## 用戶中斷

### 中斷方式

| 方式 | 效果 |
|------|------|
| 說「暫停」、「停」、「中斷」 | 安全暫停，保存進度 |
| `Ctrl+C` | 安全中斷，進度自動保存 |
| `/cancel-ralph` | 取消 Ralph Loop |

### 暫停時顯示

```
╔════════════════════════════════════════════════════════════════╗
║                    ⏸️ Loop 已暫停                               ║
╚════════════════════════════════════════════════════════════════╝

📊 當前進度: X/Y 任務完成 (Z%)
[████████████░░░░░░░░░░░░░░] Z%

💾 進度已保存。使用「繼續」或 `/ralph-loop` 恢復執行。
```

---

## 狀態恢復

### 恢復機制

當 Loop 被中斷後，可以恢復執行：

1. **關鍵字恢復**：說「繼續」或「持續執行」
2. **命令恢復**：執行 `/ralph-loop --openspec [change-id]`
3. **自動偵測**：系統會從上次中斷處繼續

### 恢復時行為

1. 讀取 `tasks.md` 找到第一個未完成任務
2. 從該任務繼續執行
3. 重置連續錯誤計數
4. 保留迭代計數（累加）

---

## 相關文件

- [openspec-workflow.md](openspec-workflow.md) - OpenSpec 工作流
- [progress-display.md](progress-display.md) - 進度視覺化
- [core-concept.md](core-concept.md) - Stop hook 核心原理
