# E2E-001: 簡單功能開發
# 測試標準 D→R→T 流程在 LOW/MEDIUM 風險下的運作

id: E2E-001
name: "簡單功能開發"
description: "測試簡單功能的完整開發流程，驗證 D→R→T 基本運作"

# 模擬指令
command: "規劃 計數器功能 loop"
alternative_commands:
  - "規劃一個簡單的計數器功能，然後 loop 執行"
  - "建立計數器組件並持續執行直到完成"

# 測試設定
settings:
  max_iterations: 5          # 最大迭代次數
  timeout_minutes: 10        # 超時時間
  bypass_mode: false         # 不啟用 bypass
  risk_override: null        # 不覆蓋風險判定

# 預期行為
expectations:
  # 流程順序
  flow:
    - agent: architect
      action: "規劃任務"
      optional: true

    - agent: developer
      action: "實作計數器"
      expected_output_contains:
        - "修改檔案"
        - "計數器"

    - agent: reviewer
      action: "審查程式碼"
      expected_verdict: "APPROVE"
      alternative_verdicts: ["APPROVE", "APPROVED", "通過"]

    - agent: tester
      action: "執行測試"
      expected_result: "PASS"
      alternative_results: ["PASS", "通過", "成功"]

  # 風險等級
  risk_level:
    expected: "MEDIUM"  # 一般功能預期為 MEDIUM
    acceptable: ["LOW", "MEDIUM"]  # 也接受 LOW

  # 合規性
  compliance:
    min_rate: 90          # 最低合規率
    max_violations: 1     # 最大違規數
    violations_must_fix: true  # 違規必須修復

  # 最終狀態
  final_state:
    all_tasks_completed: true
    state_files_cleaned: true
    no_unfixed_violations: true

# 成功條件
success_criteria:
  - "所有任務完成"
  - "合規率 >= 90%"
  - "無未修復違規"
  - "D→R→T 流程正確執行"

# 失敗條件
failure_criteria:
  - "跳過 REVIEWER"
  - "合規率 < 90%"
  - "達到最大迭代次數"
  - "超時"

# 驗證腳本（可選）
validation_script: |
  #!/bin/bash
  # 驗證 E2E-001 測試結果

  SESSION_ID="$1"
  SUMMARY=$(source tests/e2e/lib/stats-aggregator.sh && aggregate_stats "$SESSION_ID")

  # 檢查合規率
  RATE=$(echo "$SUMMARY" | grep -o '"compliance_rate":"[^"]*"' | cut -d'"' -f4 | tr -d '%')
  if [ -n "$RATE" ] && [ "$RATE" -ge 90 ]; then
    echo "✅ 合規率檢查通過: ${RATE}%"
  else
    echo "❌ 合規率檢查失敗: ${RATE}%"
    exit 1
  fi

  # 檢查違規
  VIOLATIONS=$(echo "$SUMMARY" | grep -o '"unfixed_violations":[0-9]*' | cut -d':' -f2)
  if [ "$VIOLATIONS" -eq 0 ]; then
    echo "✅ 無未修復違規"
  else
    echo "❌ 有 $VIOLATIONS 個未修復違規"
    exit 1
  fi

  echo "✅ E2E-001 測試通過"
