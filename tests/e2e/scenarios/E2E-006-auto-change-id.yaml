# E2E-006: CHANGE_ID 自動生成測試
# 測試當 OpenSpec 未提供 CHANGE_ID 時，系統自動生成唯一 ID

id: E2E-006
name: "CHANGE_ID 自動生成測試"
description: "驗證無 CHANGE_ID 時自動生成，以及並行任務有獨立 ID"

# 模擬指令
command: "規劃 用戶登入功能 loop"
alternative_commands:
  - "建立用戶登入功能，不指定 CHANGE_ID"
  - "/plan 用戶登入功能"

# 測試設定
settings:
  max_iterations: 8
  timeout_minutes: 15
  bypass_mode: false
  risk_override: null
  force_no_change_id: true  # 強制 OpenSpec 不包含 CHANGE_ID

# 預期行為
expectations:
  # 流程順序
  flow:
    - agent: architect
      action: "建立 OpenSpec（無 CHANGE_ID）"
      expected_output_contains:
        - "openspec/changes/"
      optional: true

    - agent: developer
      action: "實作任務 1"
      expected_state_file_pattern: "openspec/changes/*.developer.state.json"
      must_have_change_id: true

    - agent: reviewer
      action: "審查任務 1"
      expected_verdict: "APPROVE"

    - agent: developer
      action: "實作任務 2（並行）"
      expected_state_file_pattern: "openspec/changes/*.developer.state.json"
      must_have_different_change_id: true  # 與任務 1 不同

    - agent: tester
      action: "測試所有任務"
      expected_result: "PASS"

  # CHANGE_ID 驗證
  change_id_validation:
    # 自動生成格式：<spec-id>-<timestamp>-<counter>
    pattern: "^[a-z0-9-]+-\\d{10}-\\d+$"
    uniqueness: true  # 每個並行任務必須有獨立 ID
    persistence: true  # 重啟後 CHANGE_ID 不變

  # 合規性
  compliance:
    min_rate: 95
    max_violations: 0
    violations_must_fix: true

  # 最終狀態
  final_state:
    all_tasks_completed: true
    all_have_change_id: true
    no_duplicate_change_ids: true
    state_files_cleaned: true

# 成功條件
success_criteria:
  - "所有任務自動獲得唯一 CHANGE_ID"
  - "並行任務的 CHANGE_ID 互不相同"
  - "CHANGE_ID 格式符合規範"
  - "重啟後 CHANGE_ID 保持不變"
  - "合規率 >= 95%"

# 失敗條件
failure_criteria:
  - "存在缺失 CHANGE_ID 的狀態檔案"
  - "發現重複的 CHANGE_ID"
  - "CHANGE_ID 格式不符合規範"
  - "重啟後 CHANGE_ID 變更"

# 驗證腳本
validation_script: |
  #!/bin/bash
  # 驗證 E2E-006 測試結果

  SESSION_ID="$1"
  CHANGE_DIR="openspec/changes"

  # 1. 檢查所有狀態檔案都有 CHANGE_ID
  echo "檢查 CHANGE_ID 存在性..."
  MISSING=0
  for state in $CHANGE_DIR/*.state.json; do
    if ! grep -q '"change_id"' "$state"; then
      echo "❌ 缺失 CHANGE_ID: $state"
      MISSING=$((MISSING + 1))
    fi
  done

  if [ $MISSING -eq 0 ]; then
    echo "✅ 所有狀態檔案都有 CHANGE_ID"
  else
    echo "❌ 有 $MISSING 個檔案缺失 CHANGE_ID"
    exit 1
  fi

  # 2. 檢查 CHANGE_ID 格式
  echo "檢查 CHANGE_ID 格式..."
  INVALID=0
  for state in $CHANGE_DIR/*.state.json; do
    CHANGE_ID=$(grep -o '"change_id":"[^"]*"' "$state" | cut -d'"' -f4)
    if ! echo "$CHANGE_ID" | grep -qE '^[a-z0-9-]+-[0-9]{10}-[0-9]+$'; then
      echo "❌ 無效格式: $CHANGE_ID in $state"
      INVALID=$((INVALID + 1))
    fi
  done

  if [ $INVALID -eq 0 ]; then
    echo "✅ 所有 CHANGE_ID 格式正確"
  else
    echo "❌ 有 $INVALID 個無效格式"
    exit 1
  fi

  # 3. 檢查唯一性
  echo "檢查 CHANGE_ID 唯一性..."
  CHANGE_IDS=$(grep -h '"change_id"' $CHANGE_DIR/*.state.json | cut -d'"' -f4 | sort)
  UNIQUE_IDS=$(echo "$CHANGE_IDS" | uniq)

  if [ "$(echo "$CHANGE_IDS" | wc -l)" -eq "$(echo "$UNIQUE_IDS" | wc -l)" ]; then
    echo "✅ 所有 CHANGE_ID 唯一"
  else
    echo "❌ 發現重複的 CHANGE_ID"
    comm -23 <(echo "$CHANGE_IDS") <(echo "$UNIQUE_IDS")
    exit 1
  fi

  echo "✅ E2E-006 測試通過"
